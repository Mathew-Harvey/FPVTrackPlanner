<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPV Track Designer | Club Race Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2329b6f6'><path d='M12 2L2 7l10 5 10-5-10-5z'/></svg>">
<link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Track Designer</div>
    </div>

    <div class="notification" id="notification"></div>
    <div class="rotation-indicator" id="rotationIndicator">0Â°</div>
    
    <!-- Mobile panel overlay backdrop -->
    <div class="panel-overlay" id="panelOverlay"></div>

    <div id="canvas-container"></div>

    <div class="ui-overlay header">
        <button class="mobile-menu-btn" id="gatesMenuBtn" aria-label="Toggle Gates Menu">
            <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="logo-text">
                <h1>FPV Track Designer</h1>
                <span>Club Race Planner</span>
            </div>
        </div>
        <div class="mode-badge edit-mode" id="modeBadge">Edit Mode</div>
        <button class="mobile-menu-btn" id="controlsMenuBtn" aria-label="Toggle Controls Menu">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
    </div>

    <div class="ui-overlay gates-panel" id="gatesPanel">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Race Gates</div>
                <button class="panel-close-btn" id="closeGatesPanel" aria-label="Close">Ã—</button>
            </div>
            <div class="gate-item" data-gate="square" title="Standard 5Ã—5ft square gate">
                <div class="gate-icon">â–¢</div>
                <div class="gate-info"><h3>Square Gate</h3><span>5Ã—5 ft Standard</span></div>
            </div>
            <div class="gate-item" data-gate="arch" title="Curved arch gate">
                <div class="gate-icon">âŒ’</div>
                <div class="gate-info"><h3>Arch Gate</h3><span>Curved Top</span></div>
            </div>
            <div class="gate-item" data-gate="ladder" title="Triple stacked gates">
                <div class="gate-icon">âŠ</div>
                <div class="gate-info"><h3>Ladder Gate</h3><span>Stacked Triple</span></div>
            </div>
            <div class="gate-item" data-gate="hurdle" title="Low obstacle">
                <div class="gate-icon">âŠ“</div>
                <div class="gate-info"><h3>Hurdle</h3><span>Low Pass</span></div>
            </div>
            <div class="gate-item" data-gate="dive" title="Angled dive gate">
                <div class="gate-icon">â—‡</div>
                <div class="gate-info"><h3>Dive Gate</h3><span>Angled Entry</span></div>
            </div>
            <div class="gate-item" data-gate="flag" title="Turn marker">
                <div class="gate-icon">âš‘</div>
                <div class="gate-info"><h3>Flag Marker</h3><span>Turn Point</span></div>
            </div>
            <div class="selected-gate-info" id="selectedGateInfo">
                <h4>âœ“ <span id="selectedGateName"></span></h4>
                <p class="desktop-only">Scroll wheel to rotate<br>DEL to delete â€¢ Drag to move</p>
                <p class="mobile-only">Use buttons below to rotate<br>Tap delete â€¢ Drag to move</p>
                <div class="rotation-display">Angle: <span id="gateAngle">0Â°</span></div>
                <div class="mobile-gate-actions mobile-only">
                    <button class="btn btn-small btn-secondary" id="rotateLeftBtn">â†º -15Â°</button>
                    <button class="btn btn-small btn-secondary" id="rotateRightBtn">â†» +15Â°</button>
                    <button class="btn btn-small btn-danger" id="deleteGateBtn">ğŸ—‘</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ui-overlay controls-panel" id="controlsPanel">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Track Controls</div>
                <button class="panel-close-btn" id="closeControlsPanel" aria-label="Close">Ã—</button>
            </div>
            <button class="btn btn-primary" id="lockTrackBtn"><span>ğŸ”’</span> Lock Layout</button>
            <button class="btn btn-success" id="drawPathBtn" disabled><span>âœï¸</span> Draw Flight Path</button>
            <button class="btn btn-magenta" id="animateBtn" disabled><span>â–¶</span> Animate Drone</button>
            <div class="divider"></div>
            <button class="btn btn-secondary" id="undoBtn" disabled><span>â†©</span> Undo</button>
            <button class="btn btn-secondary" id="clearPathBtn" disabled><span>âœ•</span> Clear Path</button>
            <div class="divider"></div>
            <button class="btn btn-secondary" id="saveBtn"><span>ğŸ’¾</span> Save Track</button>
            <button class="btn btn-secondary" id="loadBtn"><span>ğŸ“‚</span> Load Track</button>
            <button class="btn btn-secondary" id="shareBtn"><span>ğŸ”—</span> Share Track</button>
            <button class="btn btn-secondary" id="exportImgBtn"><span>ğŸ–¼ï¸</span> Export Image</button>
            <div class="divider"></div>
            <button class="btn btn-danger btn-small" id="clearBtn"><span>ğŸ—‘</span> Clear All</button>
            <div class="track-info">
                <div class="track-stat"><span>Gates</span><span id="gateCount">0</span></div>
                <div class="track-stat"><span>Waypoints</span><span id="pathPoints">0</span></div>
                <div class="track-stat"><span>Track Length</span><span id="trackLength">0 m</span></div>
            </div>
        </div>
    </div>

    <div class="ui-overlay bottom-controls">
        <div class="control-group">
            <label>Speed</label>
            <input type="range" class="slider" id="speedSlider" min="1" max="10" value="5">
            <span class="slider-value" id="speedValue">5x</span>
        </div>
        <div class="control-group">
            <label>Height</label>
            <input type="range" class="slider" id="heightSlider" min="0.5" max="15" step="0.5" value="3">
            <span class="slider-value" id="heightValue">3.0m</span>
        </div>
    </div>

    <div class="ui-overlay instructions desktop-only">
        <div class="panel">
            <div class="panel-title">Controls</div>
            <div class="instruction-item"><span class="key">LMB</span><span>Select/drag gates</span></div>
            <div class="instruction-item"><span class="key">RMB</span><span>Rotate camera</span></div>
            <div class="instruction-item"><span class="key">Scroll</span><span>Zoom / Rotate gate</span></div>
            <div class="instruction-item"><span class="key">MMB</span><span>Pan camera</span></div>
            <div class="instruction-item"><span class="key">DEL</span><span>Delete selected</span></div>
            <div class="instruction-item"><span class="key">ESC</span><span>Cancel / Deselect</span></div>
            <div class="panel-title" style="margin-top:8px;margin-bottom:6px;">Path Mode</div>
            <div class="instruction-item"><span class="key">Drag</span><span>Trace flight path</span></div>
            <div class="instruction-item"><span class="key">Scroll</span><span>Adjust altitude</span></div>
        </div>
    </div>

    <!-- Mobile Touch Instructions (shows briefly on load) -->
    <div class="mobile-touch-hint mobile-only" id="touchHint">
        <div class="touch-hint-content">
            <p><strong>Touch Controls:</strong></p>
            <p>ğŸ‘† Tap to select â€¢ ğŸ‘†ğŸ‘† Two fingers to rotate view</p>
            <p>ğŸ¤ Pinch to zoom â€¢ âœ‹ Drag to pan</p>
        </div>
    </div>

    <!-- Mobile Quick Actions Bar -->
    <div class="mobile-quick-bar mobile-only" id="mobileQuickBar">
        <button class="quick-btn" id="quickGatesBtn" title="Gates">
            <span>âŠ</span>
            <small>Gates</small>
        </button>
        <button class="quick-btn" id="quickLockBtn" title="Lock">
            <span>ğŸ”’</span>
            <small>Lock</small>
        </button>
        <button class="quick-btn" id="quickPathBtn" title="Path" disabled>
            <span>âœï¸</span>
            <small>Path</small>
        </button>
        <button class="quick-btn" id="quickPlayBtn" title="Play" disabled>
            <span>â–¶</span>
            <small>Play</small>
        </button>
        <button class="quick-btn" id="quickControlsBtn" title="More">
            <span>âš™ï¸</span>
            <small>More</small>
        </button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <h2>ğŸ’¾ Save Track</h2>
            <input type="text" id="trackName" placeholder="Track Name">
            <textarea id="trackDescription" placeholder="Description (optional)"></textarea>
            <input type="text" id="authorName" placeholder="Your Name">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('saveModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTrack()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loadModal">
        <div class="modal">
            <h2>ğŸ“‚ Load Track</h2>
            <p>Paste track JSON data:</p>
            <textarea id="loadData" placeholder='{"name":"...","gates":[...]}'></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('loadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="loadTrack()">Load</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <h2>ğŸ”— Share Track</h2>
            <p><strong>Share Link</strong> â€” Anyone with this link will see your track with the drone flying:</p>
            <div class="share-url-container">
                <input type="text" id="shareUrl" readonly class="share-url-input">
                <button class="btn btn-primary share-copy-btn" onclick="copyShareUrl()">ğŸ“‹ Copy Link</button>
            </div>
            <div class="divider"></div>
            <p style="font-size:0.8rem;color:var(--text-medium);">Or copy raw JSON data:</p>
            <textarea id="shareData" readonly style="font-size:0.65rem;height:80px;"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('shareModal')">Close</button>
                <button class="btn btn-secondary" onclick="downloadTrack()">â¬‡ Download</button>
                <button class="btn btn-secondary" onclick="copyShareData()">ğŸ“‹ Copy JSON</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="script.js"></script>

</body>
</html>
